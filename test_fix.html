<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>方向计算修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .test-case {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 3px;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        .info {
            color: blue;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>方向计算修复测试</h1>
        
        <div class="test-case">
            <h3>测试1: 吕梁 -> 晋城</h3>
            <p>预期: 东南方向</p>
            <div class="result" id="result1"></div>
        </div>
        
        <div class="test-case">
            <h3>测试2: 晋城 -> 吕梁</h3>
            <p>预期: 西北方向</p>
            <div class="result" id="result2"></div>
        </div>
        
        <div class="test-case">
            <h3>测试3: 北京 -> 上海</h3>
            <p>预期: 东南方向</p>
            <div class="result" id="result3"></div>
        </div>
        
        <div class="test-case">
            <h3>测试4: 上海 -> 北京</h3>
            <p>预期: 西北方向</p>
            <div class="result" id="result4"></div>
        </div>
        
        <div class="test-case">
            <h3>测试5: 荆州 -> 纽约</h3>
            <p>预期: 东北方向</p>
            <div class="result" id="result5"></div>
        </div>
    </div>

    <script>
        // 城市坐标数据库（简化版，仅包含测试所需城市）
        const cityCoordinates = {
            // 中国城市
            '吕梁': { lat: 37.5167, lng: 111.1000 },
            '晋城': { lat: 35.4833, lng: 112.8333 },
            '北京': { lat: 39.9042, lng: 116.4074 },
            '上海': { lat: 31.2304, lng: 121.4737 },
            '荆州': { lat: 30.3351, lng: 112.2472 },
            // 外国城市
            '纽约': { lat: 40.7128, lng: -74.0060 }
        };
        
        // 计算两点之间的方位角（返回0-360度）
        function calculateBearing(lat1, lng1, lat2, lng2) {
            // 简化的方位计算，直接基于经纬度差
            // 这种方法对于地球上的大多数城市来说已经足够准确
            const deltaLat = lat2 - lat1;
            const deltaLng = lng2 - lng1;
            
            // 计算方位角（单位：度）
            let bearing;
            if (deltaLat === 0 && deltaLng === 0) {
                bearing = 0;
            } else {
                // 使用atan2计算方位角，注意参数顺序是(deltaLng, deltaLat)
                // 这是因为我们需要计算的是从北方向顺时针旋转的角度
                bearing = Math.atan2(deltaLng, deltaLat) * 180 / Math.PI;
                // 转换为0-360度
                bearing = (bearing + 360) % 360;
            }
            
            return bearing;
        }
        
        // 将方位角转换为方位名称（16方向）
        function bearingToDirection(bearing) {
            // 调整方位角，确保0-360度
            bearing = (bearing + 360) % 360;
            
            // 16方向划分
            if (bearing < 11.25 || bearing >= 348.75) {
                return '北';
            } else if (bearing >= 11.25 && bearing < 33.75) {
                return '北偏东';
            } else if (bearing >= 33.75 && bearing < 56.25) {
                return '东北';
            } else if (bearing >= 56.25 && bearing < 78.75) {
                return '东偏北';
            } else if (bearing >= 78.75 && bearing < 101.25) {
                return '东';
            } else if (bearing >= 101.25 && bearing < 123.75) {
                return '东偏南';
            } else if (bearing >= 123.75 && bearing < 146.25) {
                return '东南';
            } else if (bearing >= 146.25 && bearing < 168.75) {
                return '南偏东';
            } else if (bearing >= 168.75 && bearing < 191.25) {
                return '南';
            } else if (bearing >= 191.25 && bearing < 213.75) {
                return '南偏西';
            } else if (bearing >= 213.75 && bearing < 236.25) {
                return '西南';
            } else if (bearing >= 236.25 && bearing < 258.75) {
                return '西偏南';
            } else if (bearing >= 258.75 && bearing < 281.25) {
                return '西';
            } else if (bearing >= 281.25 && bearing < 303.75) {
                return '西偏北';
            } else if (bearing >= 303.75 && bearing < 326.25) {
                return '西北';
            } else if (bearing >= 326.25 && bearing < 348.75) {
                return '北偏西';
            }
        }
        
        // 获取两个城市之间的方向
        function getDirection(fromCity, toCity) {
            const fromCoords = cityCoordinates[fromCity];
            const toCoords = cityCoordinates[toCity];
            
            if (!fromCoords || !toCoords) {
                return '无效城市';
            }
            
            console.log('From:', fromCity, fromCoords);
            console.log('To:', toCity, toCoords);
            
            // 计算经纬度差
            const deltaLat = toCoords.lat - fromCoords.lat;
            const deltaLng = toCoords.lng - fromCoords.lng;
            
            console.log('DeltaLat:', deltaLat, 'DeltaLng:', deltaLng);
            
            // 计算方位角
            const bearing = calculateBearing(fromCoords.lat, fromCoords.lng, toCoords.lat, toCoords.lng);
            console.log('Bearing:', bearing);
            
            // 转换为方位名称
            const direction = bearingToDirection(bearing);
            console.log('Direction:', direction);
            
            return direction;
        }
        
        // 运行测试
        function runTests() {
            console.log('=== 方向计算测试 ===');
            
            // 测试1: 吕梁 -> 晋城
            const result1 = getDirection('吕梁', '晋城');
            document.getElementById('result1').innerHTML = `计算结果: ${result1} <span class="info">(方位角: ${calculateBearing(37.5167, 111.1000, 35.4833, 112.8333).toFixed(2)}°)</span>`;
            
            // 测试2: 晋城 -> 吕梁
            const result2 = getDirection('晋城', '吕梁');
            document.getElementById('result2').innerHTML = `计算结果: ${result2} <span class="info">(方位角: ${calculateBearing(35.4833, 112.8333, 37.5167, 111.1000).toFixed(2)}°)</span>`;
            
            // 测试3: 北京 -> 上海
            const result3 = getDirection('北京', '上海');
            document.getElementById('result3').innerHTML = `计算结果: ${result3} <span class="info">(方位角: ${calculateBearing(39.9042, 116.4074, 31.2304, 121.4737).toFixed(2)}°)</span>`;
            
            // 测试4: 上海 -> 北京
            const result4 = getDirection('上海', '北京');
            document.getElementById('result4').innerHTML = `计算结果: ${result4} <span class="info">(方位角: ${calculateBearing(31.2304, 121.4737, 39.9042, 116.4074).toFixed(2)}°)</span>`;
            
            // 测试5: 荆州 -> 纽约
            const result5 = getDirection('荆州', '纽约');
            document.getElementById('result5').innerHTML = `计算结果: ${result5} <span class="info">(方位角: ${calculateBearing(30.3351, 112.2472, 40.7128, -74.0060).toFixed(2)}°)</span>`;
            
            console.log('=== 测试完成 ===');
        }
        
        // 页面加载时运行测试
        window.onload = runTests;
    </script>
</body>
</html>